<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smooth Drag Grid</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 0px;
      overflow-x: hidden;
      background: #f0f0f0;
    }

    .scroll-wrapper {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 16px;
      box-sizing: border-box;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
      position: relative;
      width: 100%;
      height: auto;
    }

    .item {
      width: 120px;
      height: 140px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      user-select: none;
      cursor: grab;
      position: absolute;
      padding: 8px;
      box-sizing: border-box;
      transition: transform 300ms ease;
    }

    .item.selected {
      outline: 3px solid #007bff;
    }

    .item.placeholder {
      opacity: 0.3;
      visibility: hidden;
    }

    .thumb {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    .label {
      font-size: 12px;
      text-align: center;
      color: #333;
      word-break: break-word;
      line-height: 1.2;
    }

    .drag-preview {
      position: absolute;
      pointer-events: none;
      width: 120px;
      height: 140px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.9;
      z-index: 1000;
      transition: none;
    }

    #reorder-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      opacity: 0;
      transition:
        opacity 0.3s ease,
        transform 0.15s ease,
        box-shadow 0.15s ease,
        background 0.2s ease;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    body:hover #reorder-button {
      opacity: 1;
    }

    #reorder-button:hover {
      background: #0056d2;
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }

    #reorder-button:active {
      transform: translateX(-50%) scale(0.95);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="scroll-wrapper">
    <div class="grid" id="grid"></div>
  </div>

  <button id="reorder-button">Reorder</button>

  <script>
    const grid = document.getElementById('grid');
    let cols = 0;
    let itemSize = 0;
    
    let items = Array.from({ length: 500 }, (_, i) => (i + 1) + ".jpg");
    const itemElements = new Map();
    const selectedItems = new Set();

    let draggedIndex = null;
    let lastTargetIndex = null;
    let previewElement = null;
    let previewOffsetX = 0;
    let previewOffsetY = 0;

    let latestClientY = 0;
    let scrollIntervalId = null;
    const SCROLL_MARGIN = 60;
    const SCROLL_SPEED = 10;

    function getFileName(path) {
      return path.split('/').pop();
    }

    function startAutoScroll() {
      if (scrollIntervalId) return;
      const wrapper = document.querySelector('.scroll-wrapper');
      scrollIntervalId = setInterval(() => {
        const rect = wrapper.getBoundingClientRect();
        if (latestClientY < rect.top + SCROLL_MARGIN) {
          wrapper.scrollTop -= SCROLL_SPEED;
        } else if (latestClientY > rect.bottom - SCROLL_MARGIN) {
          wrapper.scrollTop += SCROLL_SPEED;
        }
      }, 16);
    }

    function stopAutoScroll() {
      clearInterval(scrollIntervalId);
      scrollIntervalId = null;
    }

    function createDragPreview(e, content) {
      previewElement = document.createElement('div');
      previewElement.className = 'drag-preview';
      
      previewElement.textContent = content;
      document.body.appendChild(previewElement);

      const rect = e.target.getBoundingClientRect();
      previewOffsetX = e.clientX - rect.left;
      previewOffsetY = e.clientY - rect.top;
      movePreview(e);
    }

    function movePreview(e) {
      if (previewElement) {
        previewElement.style.left = `${e.pageX - previewOffsetX}px`;
        previewElement.style.top = `${e.pageY - previewOffsetY}px`;
      }
    }

    function getOffset(el) {
      const rect = el.getBoundingClientRect();
      return {
        top: rect.top + window.scrollY,
        left: rect.left + window.scrollX
      };
    }

    function onMouseMove(e) {
      latestClientY = e.clientY;
      movePreview(e);
      startAutoScroll();

      const { top: gridTop, left: gridLeft } = getOffset(grid);
      const x = e.pageX - gridLeft;
      const y = e.pageY - gridTop;

      const col = Math.floor(x / itemSize);
      const row = Math.floor(y / itemSize);
      const targetIndex = row * cols + col;

      if (
        draggedIndex !== null &&
        targetIndex >= 0 &&
        targetIndex < items.length &&
        targetIndex !== lastTargetIndex
      ) {
        // to get selected items with preserve order
        const draggedItems = items.filter(i => selectedItems.has(i));
        if (draggedItems.length === 0) return;

        items = items.filter(i => !selectedItems.has(i));
        items.splice(targetIndex, 0, ...draggedItems);

        draggedIndex = targetIndex;
        lastTargetIndex = targetIndex;

        updateItemsPosition(targetIndex);
      }
    }

    function onMouseUp() {
      if (previewElement) {
        previewElement.remove();
        previewElement = null;
      }

      stopAutoScroll();
      updateItemsPosition();

      const isSingle = selectedItems.size === 1;
      selectedItems.forEach((element, id) => {
        itemElements.get(id).classList.remove(isSingle ? 'placeholder' : 'selected');
      });

      draggedIndex = null;
      lastTargetIndex = null;
      selectedItems.clear();

      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    }

    function renderOnce() {
      items.forEach((item, index) => {
        const filename = getFileName(item);
        
        const div = document.createElement('div');
        div.className = 'item';

        const img = document.createElement('img');
        img.src = item;
        img.alt = `Image ${filename}`;
        img.className = 'thumb';

        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = filename;

        div.appendChild(img);
        div.appendChild(label);
        grid.appendChild(div);
        itemElements.set(item, div);

        div.addEventListener('mousedown', (e) => {
          if (e.shiftKey) {
            if (selectedItems.has(item)) {
              selectedItems.delete(item);
              div.classList.remove('selected');
            } else {
              selectedItems.add(item);
              div.classList.add('selected');
            }
            return;
          }

          // Select one item
          if (!selectedItems.has(item)) {
            selectedItems.forEach((element, id) => {
              itemElements.get(id).classList.remove('selected');
            });
            selectedItems.clear();
            selectedItems.add(item);
            div.classList.add('placeholder');
          }

          draggedIndex = index;

          const isSingle = selectedItems.size === 1;
          const content = isSingle ? Array.from(selectedItems)[0] : `${selectedItems.size} item(s)`;
          createDragPreview(e, content);

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });

      updateGridMetrics();
      updateItemsPosition();
    }

    function updateGridMetrics() {
      const sampleItem = itemElements.values().next().value;
      if (!sampleItem) return;

      const rect = sampleItem.getBoundingClientRect();
      itemSize = rect.width + 12;
      cols = Math.floor(grid.clientWidth / itemSize);

      const rowCount = Math.ceil(items.length / cols);
      grid.style.height = `${rowCount * itemSize}px`;
    }

    function calculatePosition(index) {
      const row = Math.floor(index / cols);
      const col = index % cols;
      const totalWidth = cols * itemSize;
      const gridWidth = grid.clientWidth;
      const offsetX = (gridWidth - totalWidth) / 2;
      return {
        x: offsetX + col * itemSize,
        y: row * itemSize
      };
    }

    function updateItemsPosition() {
      items.forEach((item, index) => {
        const el = itemElements.get(item);
        const pos = calculatePosition(index);
        const targetTransform = `translate(${pos.x}px, ${pos.y}px)`;
        if (el.style.transform !== targetTransform) {
          el.style.transform = targetTransform;
        }
      });
    }

    renderOnce();

    const observer = new ResizeObserver(() => {
      updateGridMetrics();
      updateItemsPosition();
    });
    observer.observe(grid);

    document.getElementById('rename-button').addEventListener('click', () => {
      //TODO: to be implement
    });
  </script>
</body>
</html>
